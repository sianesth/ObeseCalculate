<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SiAnesthetics for obese patients</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* สีพื้นหลังตาม Tailwind bg-gray-100 */
        }

        /* ตัวจัดเรียงแถวพื้นฐานสำหรับคู่ค่า-คีย์ในแต่ละส่วน */
        .label-row {
            display: grid;
            grid-template-columns: 1fr 1fr; /* สองคอลัมน์ */
            gap: 0.25rem 1rem;
            align-items: start;
            padding: 0.5rem 0.75rem;
            font-size: 0.90rem;
            line-height: 1.35;
            border-radius: 0.4rem;
            box-shadow: 0 1px 2px rgb(0 0 0 / 0.05);
        }

        .label-title {
            font-weight: 600;
            color: #000;
            white-space: pre-wrap;
            text-transform: capitalize;
            font-size: 0.90rem;
            line-height: 1.2;
            min-width: 150px; /* ให้พื้นที่สำหรับหัวข้อ */
        }

        /* การเยื้องสำหรับ label-title เมื่อเป็นส่วนหนึ่งของส่วนที่สลับเปิด-ปิดได้ */
        .section-content-area .label-title {
            padding-left: 1.5ch; /* เยื้องไป 1.5 ตัวอักษร */
        }

        /* สไตล์สำหรับข้อความผลลัพธ์โดยทั่วไป */
        .label-result {
            font-weight: 600;
            color: #1e3a8a;
            white-space: pre-wrap;
            line-height: 1.35;
            font-size: 0.90rem;
            text-align: left; /* จัดข้อความภายใน div นี้ชิดซ้ายเสมอเพื่อความสอดคล้อง */
        }

        /* --- สไตล์สำหรับกรอบหัวข้อหลักของแต่ละส่วน (ชื่อเรื่องและปุ่มสลับ/ผลลัพธ์) --- */
        .section-header-box { /* นี่คือกรอบหัวข้อหลัก */
            padding: 0.5rem 0.75rem;
            border-radius: 0.4rem;
            box-shadow: 0 1px 2px rgb(0 0 0 / 0.05);
            margin-bottom: 0.5rem; /* ระยะห่างระหว่างกรอบหัวข้อกับเนื้อหา (ถ้ามี) */
            font-size: 0.9rem;
            font-weight: 600;
            color: #000;
            min-height: 48px;
        }

        /* สไตล์สำหรับหัวข้อที่มีปุ่มสลับ */
        .section-header-box.with-toggle {
            display: grid; /* ใช้ grid สำหรับจัดตำแหน่งชื่อเรื่องและปุ่มสลับ/ผลลัพธ์ */
            grid-template-columns: 1fr auto; /* สองคอลัมน์: คอลัมน์แรกใช้พื้นที่ที่เหลือ, คอลัมน์ที่สองความกว้างอัตโนมัติ */
            align-items: center;
        }

        .section-header-box.with-toggle > label:first-child { /* สไตล์สำหรับป้ายชื่อเรื่อง */
            grid-column: 1;
            text-align: left;
        }

        .section-header-box.with-toggle > label.switch { /* สไตล์สำหรับป้ายชื่อปุ่มสลับ */
            grid-column: 2;
            justify-self: end; /* จัดตำแหน่งไปทางขวาของเซลล์ grid */
            margin-right: 8ch; /* เพิ่มระยะห่างจากด้านขวา โดยใช้หน่วย 'ch' ซึ่งประมาณความกว้างของตัวอักษร '0' */
        }

        /* สไตล์กรอบหัวข้อเฉพาะสำหรับ Fentanyl และ Neostigmine ให้ทำงานเหมือน label-row */
        .fentanyl-neostigmine-header {
            display: grid; /* ใช้ grid สำหรับการจัดตำแหน่ง */
            grid-template-columns: 1fr 1fr; /* สองคอลัมน์เหมือน label-row */
            gap: 0.25rem 1rem; /* ระยะห่างเหมือน label-row */
            align-items: start;
            padding: 0.5rem 0.75rem; /* ระยะห่างภายในเท่ากัน */
            font-size: 0.90rem; /* ขนาดตัวอักษรเท่ากัน */
            line-height: 1.35; /* ความสูงบรรทัดเท่ากัน */
        }

        /* สไตล์เฉพาะสำหรับข้อความภายในหัวข้อ Fentanyl/Neostigmine */
        .fentanyl-neostigmine-header .label-title {
            font-weight: 600;
        }

        .fentanyl-neostigmine-header .label-result {
            font-weight: 600;
        }

        /* สไตล์สำหรับข้อความที่เล็กกว่าใต้ header-result (ตอนนี้เป็นส่วนหนึ่งของ label-result) */
        .label-result span {
            font-weight: normal;
            font-size: 0.75em;
            display: inline; /* เปลี่ยนจาก block เป็น inline */
            line-height: 1.1;
        }

        /* --- สไตล์สำหรับพื้นที่เนื้อหา (เนื้อหาที่สลับเปิด-ปิดได้) --- */
        .section-content-area {
            display: block;
            padding-left: 0;
            padding-right: 0;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* ปรับระยะห่างของ label-rows ภายในพื้นที่เนื้อหา */
        .section-content-area .label-row {
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 2px rgb(0 0 0 / 0.05);
        }

        /* สีพื้นหลังเฉพาะสำหรับกรอบหัวข้อแต่ละส่วน */
        .propofol-header-bg { background-color: #FFF2B2; }
        .fentanyl-header-bg { background-color: #a7d9ed; }
        .musclerelaxant-header-bg { background-color: #FF9BA3; }
        /* พื้นหลัง Neostigmine สีขาว ตามที่ร้องขอ */
        .neostigmine-header-bg {
            background-color: #ffffff; /* สีขาว */
            border: 2.5px dashed red; /* เส้นประยาวสีแดง */
        }
        .medications-header-bg { background-color: #ccdad1; }
        .extra-header-bg { background-color: #f4f3ee; }

        /* กำหนดสีพื้นหลังสำหรับพื้นที่เนื้อหาตามสีพื้นหลังของหัวข้อแม่ */
        #Prop.section-content-area .label-row {
            background-color: #fefae0;
        }

        #musc.section-content-area .label-row {
            background-color: #FFBCC1
        }

        #meds.section-content-area .label-row {
            background-color: #e2ece9;
        }

        #extra.section-content-area .label-row {
            background-color: #fbfaf8;
        }

        /* --- สไตล์ปุ่มสลับ (Toggle Switch) --- */
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #b0bec5;
            transition: 0.4s; border-radius: 24px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white;
            transition: 0.4s; border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider {
            background-color: #42a5f5;
        }
        input:checked + .slider:before { transform: translateX(20px); }

        .section-header-box.with-toggle > label.switch {
            grid-column: 2;
            justify-self: end;
            margin-right: 3ch;
        }

        /* การปรับระยะห่างให้กระชับขึ้น */
        /* ลดระยะห่างด้านบนสำหรับคอนเทนเนอร์ผลลัพธ์หลัก */
        #mainResultContainer {
            margin-top: 0.75rem; /* กำหนดระยะห่างระหว่างกล่องข้อมูลนำเข้าและกล่องผลลัพธ์แรก */
            padding-top: 0; /* ลบ padding จากด้านบนของกล่องผลลัพธ์โดยรวม */
            padding-bottom: 0; /* ลบ padding จากด้านล่างของกล่องผลลัพธ์โดยรวม */
        }

        /* สไตล์สำหรับ baseInfo (BMI/Category) */
        #baseInfo {
            margin-bottom: 0;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            box-shadow: none; /* ลบเงา */
            border: none; /* ลบขอบทั้งหมดจาก #baseInfo */
        }

        /* กำหนดให้ label-row ที่อยู่ใน #baseInfo ไม่มีเงาและขอบ */
        #baseInfo .label-row {
            box-shadow: none; /* ลบเงา */
            border: none; /* ลบขอบ */
            background-color: transparent; /* อาจจะต้องเพิ่มเพื่อให้พื้นหลังโปร่งใส หรือใช้ bg-gray-100 จาก Tailwind */
        }

        /* คงการกำหนด border radius ด้านบนสำหรับ baseInfo */
        #baseInfo.rounded-xl {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        /* ปรับส่วนหัวข้อแรกให้มีระยะห่างด้านบนเล็กน้อยหากจำเป็น และปรับขอบให้เข้ากัน */
        #resultSections > div:first-child { /* กำหนดเป้าหมายเฉพาะหัวข้อ Propofol */
            margin-top: 0; /* ไม่มี margin-top ตรงนี้ถ้า baseInfo ไม่มี margin-bottom */
            border-top-left-radius: 0; /* ทำให้มุมเรียบเมื่อชนกับ baseInfo */
            border-top-right-radius: 0;
        }

        /* ตรวจสอบให้แน่ใจว่าแต่ละส่วนผลลัพธ์มี margin-top สำหรับการเว้นระยะระหว่างกัน */
        #resultSections > .section-header-box {
            margin-top: 0.75rem; /* ระยะห่างคงที่ระหว่างส่วนยา */
        }
        /* ส่วนแรกสุดใน resultSections (Propofol) ไม่ควรมี margin-top */
        #resultSections > .section-header-box:first-of-type {
            margin-top: 0;
        }

        /* ถ้า baseInfo และ resultSections รวมกันในเชิงภาพ ให้ลบ box-shadow ระหว่างกัน */
        #baseInfo + #resultSections > .section-header-box:first-of-type {
            box-shadow: 0 1px 2px rgb(0 0 0 / 0.05); /* เพิ่มเงาให้กับส่วนยาแรกอีกครั้ง */
        }

    </style>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#22c55e">
</head>

<body class="bg-gray-100 text-gray-800">
    <header class="bg-gray-100 py-1 pb-2 z-10 relative">
        <div class="flex items-center gap-3 justify-center px-4 max-w-full">
            <img src="logo1.png" alt="โลโก้ศิริราช" class="w-12 sm:w-14 h-auto flex-shrink-0">
            <div class="text-sm text-gray-800 leading-snug text-center">
                <h1 class="font-semibold text-base sm:text-lg">Anesthetics for obese patients</h1>
                <p class="text-gray-600 text-sm sm:text-base">คำนวณขนาดยาสำหรับผู้ป่วย obesity (BMI ≥30)</p>
            </div>
        </div>
    </header>

    <main class="mx-auto px-3 max-w-screen-sm mt-0">
        <div class="bg-white p-4 pl-10 rounded-xl shadow-md space-y-4">
            <div role="radiogroup" aria-labelledby="gender-label">
                <label id="gender-label" class="block font-medium mb-1">Gender :</label>
                <div class="flex space-x-4">
                    <button type="button" class="bg-white px-4 py-1.5 border rounded mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" id="btnMale" role="radio" aria-checked="false" onclick="selectSex('male')">👦🏻 Male</button>
                    <button type="button" class="bg-white px-4 py-1.5 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" id="btnFemale" role="radio" aria-checked="false" onclick="selectSex('female')">👧🏻 Female</button>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <label for="weight" class="font-medium w-28">Weight (kg):</label>
                <input type="number" id="weight" class="border rounded px-3 py-1.5 w-20 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" placeholder="XXX" autocomplete="off" />
            </div>

            <div class="flex items-center gap-2">
                <label for="height" class="font-medium w-28">Height (cm):</label>
                <input type="number" id="height" class="border rounded px-3 py-1.5 w-20 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50" placeholder="เช่น XXX" autocomplete="off" />
            </div>

            <div class="flex gap-4 ">
                <button type="button" class="bg-green-500 text-white px-3 py-1.5 rounded hover:bg-green-600 w-fit focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50" onclick="calculate()">Calculate</button>
                <button type="button" class="bg-gray-400 text-white px-3 py-1.5 rounded hover:bg-gray-500 w-fit" onclick="resetForm()">Reset</button>
            </div>
        </div>

        <div id="mainResultContainer" class="hidden mt-1 rounded-xl">
            <div class="bg-gray-100 rounded-t-xl rounded-b-none shadow-md p-4 leading-tight" id="baseInfo"></div>

            <div id="resultSections" class="hidden rounded-b-xl">
                <div class="section-header-box propofol-header-bg with-toggle" id="toggleProp">
                    <label class="font-semibold text-[0.95rem]">1. Propofol</label>
                    <label class="switch">
                        <input onclick="toggle('Prop')" type="checkbox" autocomplete="off" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="hidden section-content-area" id="Prop"></div>

                <div class="section-header-box fentanyl-header-bg fentanyl-neostigmine-header" id="fentanylHeader">
                    <div class="label-title">2. Fentanyl</div>
                    <div id="fentanylResult" class="label-result"></div>
                </div>

                <div class="section-header-box musclerelaxant-header-bg with-toggle" id="toggleMusc">
                    <label class="font-semibold text-[0.95rem]">3. Muscle relaxant</label>
                    <label class="switch">
                        <input onclick="toggle('musc')" type="checkbox" autocomplete="off" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="hidden section-content-area" id="musc"></div>

                <div class="section-header-box neostigmine-header-bg fentanyl-neostigmine-header" id="neostigmineHeader">
                    <div class="label-title">4. Neostigmine</div>
                    <div id="neostigmineResult" class="label-result"></div>
                </div>

                <div class="section-header-box medications-header-bg with-toggle" id="toggleMeds">
                    <label class="font-semibold text-[0.95rem]">5. Other medications</label>
                    <label class="switch">
                        <input onclick="toggle('meds')" type="checkbox" autocomplete="off" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="hidden section-content-area" id="meds"></div>

                <div class="section-header-box extra-header-bg with-toggle" id="toggleExtra">
                    <label class="font-semibold text-[0.95rem]">6. Addition information</label>
                    <label class="switch">
                        <input onclick="toggle('extra')" type="checkbox" autocomplete="off" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="hidden section-content-area" id="extra"></div>
            </div>
        </div>
    </main>

    <footer class="text-center text-[0.65rem] text-gray-500 mt-10 px-4">
        <p>&copy; 2025 | ภาควิชาวิสัญญีวิทยา คณะแพทยศาสตร์ศิริราชพยาบาล</p>
        <p>Version 1.0</p>
    </footer>

    <script>
        let sex = '';

        // รับการอ้างอิงถึงองค์ประกอบ DOM เพียงครั้งเดียว
        const btnMale = document.getElementById('btnMale');
        const btnFemale = document.getElementById('btnFemale');
        const weightInput = document.getElementById('weight');
        const heightInput = document.getElementById('height');

        // คอนเทนเนอร์หลักสำหรับผลลัพธ์ทั้งหมด (BMI/Category และส่วนที่ 1-6)
        const mainResultContainer = document.getElementById('mainResultContainer');
        const baseInfoDiv = document.getElementById('baseInfo'); // BMI, Category และข้อความปกติ
        const resultSectionsDiv = document.getElementById('resultSections'); // คอนเทนเนอร์เฉพาะส่วนที่ 1-6

        // การอ้างอิงสำหรับพื้นที่เนื้อหา (div ที่สลับเปิด-ปิดได้)
        const propDiv = document.getElementById('Prop');
        const muscDiv = document.getElementById('musc');
        const medsDiv = document.getElementById('meds');
        const extraDiv = document.getElementById('extra');

        // การอ้างอิงถึง div ผลลัพธ์ *ภายใน* หัวข้อที่ไม่สลับเปิด-ปิด
        const fentanylResultDiv = document.getElementById('fentanylResult');
        const neostigmineResultDiv = document.getElementById('neostigmineResult');

        // การอ้างอิงถึงคอนเทนเนอร์หัวข้อ (div ที่มีคลาส section-header-box)
        const togglePropHeader = document.getElementById('toggleProp');
        const fentanylHeader = document.getElementById('fentanylHeader');
        const toggleMuscHeader = document.getElementById('toggleMusc');
        const neostigmineHeader = document.getElementById('neostigmineHeader');
        const toggleMedsHeader = document.getElementById('toggleMeds');
        const toggleExtraHeader = document.getElementById('toggleExtra');

        // ฟังก์ชันยูทิลิตี้สำหรับการจัดรูปแบบผลลัพธ์
        const range = (low, high, unit) => `${low.toFixed(0)} - ${high.toFixed(0)} ${unit}`;
        const single = (val, unit) => {
            const fixedVal = parseFloat(val.toFixed(2));
            return `${fixedVal} ${unit}`;
        };

        function selectSex(val) {
            sex = val;
            btnMale.classList.remove('bg-blue-500', 'text-white');
            btnFemale.classList.remove('bg-blue-500', 'text-white');

            // อัปเดตคุณสมบัติ ARIA สำหรับการเข้าถึง (accessibility)
            btnMale.setAttribute('aria-checked', 'false');
            btnFemale.setAttribute('aria-checked', 'false');

            if (val === 'male') {
                btnMale.classList.add('bg-blue-500', 'text-white');
                btnMale.setAttribute('aria-checked', 'true');
            } else {
                btnFemale.classList.add('bg-blue-500', 'text-white');
                btnFemale.setAttribute('aria-checked', 'true');
            }
        }

        function toggle(id) {
            document.getElementById(id).classList.toggle('hidden');
        }

        function resetForm() {
            sex = '';
            weightInput.value = '';
            heightInput.value = '';
            btnMale.classList.remove('bg-blue-500', 'text-white');
            btnFemale.classList.remove('bg-blue-500', 'text-white');

            // รีเซ็ตคุณสมบัติ ARIA สำหรับปุ่มเพศ
            btnMale.setAttribute('aria-checked', 'false');
            btnFemale.setAttribute('aria-checked', 'false');

            mainResultContainer.classList.add('hidden'); // ซ่อนคอนเทนเนอร์ผลลัพธ์หลักทั้งหมด
            resultSectionsDiv.classList.add('hidden'); // ตรวจสอบให้แน่ใจว่าส่วนที่ 1-6 ถูกซ่อน

            // ตรวจสอบให้แน่ใจว่าหัวข้อทั้งหมดปรากฏอีกครั้งเมื่อรีเซ็ต (สำหรับการคำนวณครั้งถัดไป)
            togglePropHeader.classList.remove('hidden');
            fentanylHeader.classList.remove('hidden');
            toggleMuscHeader.classList.remove('hidden');
            neostigmineHeader.classList.remove('hidden');
            toggleMedsHeader.classList.remove('hidden');
            toggleExtraHeader.classList.remove('hidden');

            // ซ่อนเนื้อหาส่วนที่สลับเปิด-ปิดได้ทั้งหมดและยกเลิกการเลือกสวิตช์
            const toggledSections = ['Prop', 'musc', 'meds', 'extra'];
            toggledSections.forEach(id => {
                const sectionContent = document.getElementById(id);
                sectionContent.classList.add('hidden'); // ตรวจสอบให้แน่ใจว่าเนื้อหาถูกซ่อน

                const toggleContainerId = `toggle${id.charAt(0).toUpperCase() + id.slice(1)}`;
                const toggleSwitchContainer = document.getElementById(toggleContainerId);
                if (toggleSwitchContainer) {
                    const toggleSwitch = toggleSwitchContainer.querySelector('input[type="checkbox"]');
                    if (toggleSwitch) {
                        toggleSwitch.checked = false; // ยกเลิกการเลือกสวิตช์
                    }
                }
            });

            // ล้างเนื้อหาของ div ผลลัพธ์ทั้งหมด รวมถึง Fentanyl และ Neostigmine
            baseInfoDiv.innerHTML = '';
            propDiv.innerHTML = '';
            fentanylResultDiv.innerHTML = '';
            muscDiv.innerHTML = '';
            neostigmineResultDiv.innerHTML = '';
            medsDiv.innerHTML = '';
            extraDiv.innerHTML = '';
        }

        function labelRow(label, value) {
            return `
                <div class="label-row">
                    <div class="label-title">${label}</div>
                    <div class="label-result">${value}</div>
                </div>
            `;
        }

        function calculateBodyMetrics(w, h, sex) {
            const bmi = w / ((h / 100) ** 2);
            const cat = bmi < 18.5 ? 'Underweight' :
                        bmi < 25 ? 'Normal' :
                        bmi < 30 ? 'Overweight' :
                        bmi < 35 ? 'Obese GRADE I' :
                        bmi < 40 ? 'Obese GRADE II' :
                        'Obese GRADE III/Morbidly Obese';
            const inch = h / 2.54;
            const ibw = sex === 'male' ? 50 + 2.3 * (inch - 60) : 45.5 + 2.3 * (inch - 60);
            const lbw = sex === 'male' ? (9270 * w) / (6680 + 216 * bmi) : (9270 * w) / (8780 + 244 * bmi);
            const adjbw = w > ibw ? ibw + 0.4 * (w - ibw) : ibw;
            const pbw = sex === 'male' ? 50 + 0.91 * (h - 152.4) : 45.5 + 0.91 * (h - 152.4);
            return { bmi, cat, ibw, lbw, adjbw, pbw };
        }

        function updateBaseInfoDisplay(bmi, cat, isNormal) {
            baseInfoDiv.classList.remove('rounded-xl');
            baseInfoDiv.classList.add('rounded-t-xl', 'rounded-b-none');
            let htmlContent = `${labelRow('BMI', bmi.toFixed(1))}${labelRow('Category', cat)}`;
            if (isNormal) {
                htmlContent += `
                    <div class="mt-4 text-center text-red-600 font-semibold text-base">
                        *💉 ใช้การคำนวณยาปกติ 💉*
                    </div>
                `;
            }
            baseInfoDiv.innerHTML = htmlContent;
        }

        function renderDrugSections(lbw, adjbw, w, ibw, pbw) {
            // ตรวจสอบให้แน่ใจว่าหัวข้อทั้งหมดปรากฏถ้าไม่ใช่ 'Normal' (ในกรณีที่ผู้ใช้เปลี่ยนจาก Normal)
            togglePropHeader.classList.remove('hidden');
            fentanylHeader.classList.remove('hidden');
            toggleMuscHeader.classList.remove('hidden');
            neostigmineHeader.classList.remove('hidden');
            toggleMedsHeader.classList.remove('hidden');
            toggleExtraHeader.classList.remove('hidden');

            // --- 1. Propofol (เนื้อหาที่สลับเปิด-ปิดได้) ---
            propDiv.innerHTML = `
                ${labelRow('Induction', `${range(1.5 * lbw, 2.5 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(1.5–2.5 mg/kg LBW)</span>`)}
                ${labelRow('Infusion <span class="font-normal">(GA)</span>',
                                `${range(adjbw * 0.1 * 60, adjbw * 0.2 * 60, 'mg/hr')}<br><span class='font-normal text-[0.75em]'>(100–200 mcg/kg/min AdjBW)</span>`)}
                ${labelRow('Infusion <span class="font-normal">(Sedation)</span>',
                                `${range(adjbw * 0.025 * 60, adjbw * 0.1 * 60, 'mg/hr')}<br><span class='font-normal text-[0.75em]'>(25–100 mcg/kg/min AdjBW)</span>`)}
            `;

            // --- 2. Fentanyl (ผลลัพธ์แสดงโดยตรงในหัวข้อ) ---
            fentanylResultDiv.innerHTML = `${range(1 * lbw, 2 * lbw, 'mcg')}<br><span class='font-normal text-[0.75em]'>(1‑2 mcg/kg LBW)</span>`;

            // --- 3. Muscle relaxant (เนื้อหาที่สลับเปิด-ปิดได้) ---
            muscDiv.innerHTML = `
                ${labelRow('Succinylcholine', `${single(w, 'mg')}<br><span class='font-normal text-[0.75em]'>(1 mg/kg TBW)</span>`)}
                ${labelRow('Atracurium', `${single(0.6 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.6 mg/kg LBW)</span>`)}
                ${labelRow('Cisatracurium', `${single(0.15 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.15 mg/kg LBW)</span>`)}
                ${labelRow('Rocuronium', `${range(0.6 * lbw, 0.9 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.6‑0.9 mg/kg LBW)</span>`)}
            `;

            // --- 4. Neostigmine (ผลลัพธ์แสดงโดยตรงในหัวข้อ) ---
            neostigmineResultDiv.innerHTML = `${single(0.05 * adjbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.05 mg/kg AdjBW)</span>`;

            // --- 5. Other medications (เนื้อหาที่สลับเปิด-ปิดได้) ---
            medsDiv.innerHTML = `
                ${labelRow('Etomidate', `${range(0.2 * lbw, 0.3 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.2‑0.3 mg/kg LBW)</span>`)}
                ${labelRow('Thiopental', `${range(3 * lbw, 5 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(3‑5 mg/kg LBW)</span>`)}
                ${labelRow('Ketamine <span class="font-normal">(Infusion)</span>',
                                `${range(0.5 * lbw, 1 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.5‑1 mg/kg LBW)</span>`)}
                ${labelRow('Midazolam', `${range(0.05 * lbw, 0.1 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.05‑0.1 mg/kg LBW)</span>`)}
                ${labelRow('Dexmedetomidine <span class="font-normal">(Loading infusion)</span>',
                                `${range(0.5 * lbw, 1 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.5‑1 mg/kg LBW)</span>`)}
                ${labelRow('Morphine', `${range(0.05 * lbw, 0.1 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(0.05‑0.1 mg/kg LBW)</span>`)}
                ${labelRow('Sugammadex', `${range(2 * adjbw, 4 * adjbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(2‑4 mg/kg AdjBW)</span>`)}
                ${labelRow('Lidocaine <span class="font-normal">(IV)</span>',
                                `${range(1 * lbw, 2 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(1‑2 mg/kg LBW)</span>`)}
                ${labelRow('Lidocaine <span class="font-normal">(Local)</span>',
                                `${range(5 * lbw, 7 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(5‑7 mg/kg LBW)</span>`)}
                ${labelRow('Bupivacaine <span class="font-normal">(Local)</span>',
                                `${single(3 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(3 mg/kg LBW)</span>`)}
                ${labelRow('Paracetamol', `${single(15 * lbw, 'mg')}<br><span class='font-normal text-[0.75em]'>(15 mg/kg LBW)</span>`)}
            `;

            // --- 6. Additional Information (เนื้อหาที่สลับเปิด-ปิดได้) ---
            extraDiv.innerHTML = `
                ${labelRow('IBW <span class="font-normal">(Ideal Body Weight)</span>',
                                `${ibw.toFixed(0)} kg <span class="font-normal text-[0.75em] ">(สำหรับการให้สารน้ำ)</span>`)}
                ${labelRow('LBW <span class="font-normal">(Lean Body Weight)</span>',
                                `${lbw.toFixed(0)} kg`)}
                ${labelRow('AdjBW <span class="font-normal">(Adjusted Body Weight)</span>',
                                `${adjbw.toFixed(0)} kg`)}
                ${labelRow('PBW <span class="font-normal">(Predicted Body Weight)</span>',
                                `${pbw.toFixed(0)} kg <span class="font-normal text-[0.75em]">(สำหรับ ventilator setting)</span>`)}
            `;
        }

        function resetDrugSectionsContent() {
            propDiv.innerHTML = '';
            fentanylResultDiv.innerHTML = '';
            muscDiv.innerHTML = '';
            neostigmineResultDiv.innerHTML = '';
            medsDiv.innerHTML = '';
            extraDiv.innerHTML = '';

            // ตรวจสอบให้แน่ใจว่าสวิตช์ถูกยกเลิกการเลือกและพื้นที่เนื้อหาถูกซ่อน
            const toggledSections = ['Prop', 'musc', 'meds', 'extra'];
            toggledSections.forEach(id => {
                const sectionContent = document.getElementById(id);
                sectionContent.classList.add('hidden');
                const toggleSwitchContainer = document.getElementById(`toggle${id.charAt(0).toUpperCase() + id.slice(1)}`);
                if (toggleSwitchContainer) {
                    const toggleSwitch = toggleSwitchContainer.querySelector('input[type="checkbox"]');
                    if (toggleSwitch) {
                        toggleSwitch.checked = false;
                    }
                }
            });
        }

        function calculate() {
            const w = parseFloat(weightInput.value);
            const h = parseFloat(heightInput.value);

            if (!sex || isNaN(w) || isNaN(h)) {
                alert('กรุณาเลือกเพศ และกรอกน้ำหนัก-ส่วนสูงให้ครบ');
                return;
            }

            const { bmi, cat, ibw, lbw, adjbw, pbw } = calculateBodyMetrics(w, h, sex);

            mainResultContainer.classList.remove('hidden'); // แสดงคอนเทนเนอร์หลักเสมอ

            if (cat === 'Normal') {
                resultSectionsDiv.classList.add('hidden'); // ซ่อนเฉพาะส่วนที่ 1-6
                updateBaseInfoDisplay(bmi, cat, true); // true สำหรับข้อความปกติ
                resetDrugSectionsContent(); // ล้างเนื้อหาที่อาจเหลือจากการคำนวณก่อนหน้าในส่วนที่ซ่อน
            } else {
                resultSectionsDiv.classList.remove('hidden'); // แสดงส่วนที่ 1-6
                updateBaseInfoDisplay(bmi, cat, false); // false สำหรับไม่แสดงข้อความปกติ
                renderDrugSections(lbw, adjbw, w, ibw, pbw); // ส่งค่าที่คำนวณได้ทั้งหมดที่จำเป็น
            }

            sendToGoogleSheets({
                sex,
                weight: w,
                height: h,
                bmi: bmi.toFixed(1),
                category: cat,
                ibw: ibw.toFixed(0),
                lbw: lbw.toFixed(0),
                adjbw: adjbw.toFixed(0),
                pbw: pbw.toFixed(0),
                propofolInduction: `${(1.5 * lbw).toFixed(0)} - ${(2.5 * lbw).toFixed(0)} mg`,
                propofolInfusionSedation: `${(adjbw * 0.025 * 60).toFixed(0)} - ${(adjbw * 0.1 * 60).toFixed(0)} mg/hr`,
                propofolInfusionGA: `${(adjbw * 0.1 * 60).toFixed(0)} - ${(adjbw * 0.2 * 60).toFixed(0)} mg/hr`,
                fentanyl: `${(1 * lbw).toFixed(0)} - ${(2 * lbw).toFixed(0)} mcg`,
                succinylcholine: `${w.toFixed(0)} mg`,
                atracurium: `${(0.6 * lbw).toFixed(0)} mg`,
                cisatracurium: `${(0.15 * lbw).toFixed(0)} mg`,
                rocuronium: `${(0.6 * lbw).toFixed(0)} - ${(0.9 * lbw).toFixed(0)} mg`,
                neostigmine: `${(0.05 * adjbw).toFixed(2)} mg`,
                etomidate: `${(0.2 * lbw).toFixed(0)} - ${(0.3 * lbw).toFixed(0)} mg`,
                thiopental: `${(3 * lbw).toFixed(0)} - ${(5 * lbw).toFixed(0)} mg`,
                ketamine: `${(0.5 * lbw).toFixed(0)} - ${(1 * lbw).toFixed(0)} mg`,
                midazolam: `${(0.05 * lbw).toFixed(2)} - ${(0.1 * lbw).toFixed(2)} mg`,
                dexmedetomidine: `${(0.5 * lbw).toFixed(2)} - ${(1 * lbw).toFixed(2)} mg`,
                morphine: `${(0.05 * lbw).toFixed(2)} - ${(0.1 * lbw).toFixed(2)} mg`,
                sugammadex: `${(2 * adjbw).toFixed(2)} - ${(4 * adjbw).toFixed(2)} mg`,
                lidocaineIV: `${(1 * lbw).toFixed(0)} - ${(2 * lbw).toFixed(0)} mg`,
                lidocaineLocal: `${(5 * lbw).toFixed(0)} - ${(7 * lbw).toFixed(0)} mg`,
                bupivacaineLocal: `${(3 * lbw).toFixed(0)} mg`,
                paracetamol: `${(15 * lbw).toFixed(0)} mg`
            });
        }

        function sendToGoogleSheets(data) {
            fetch("https://script.google.com/macros/s/AKfycbxqVmSgnJgG4eVj4z2hWD2tJuWO1vZGQIaJrSfRguzmmf_8Iq0Edycq6HfJDu7n9rw/exec", {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
        }
    </script>
</body>
</html>